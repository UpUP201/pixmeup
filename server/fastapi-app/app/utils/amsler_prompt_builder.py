def build_amsler_prompt(survey, amsler_test_list):
    import re
    sorted_list = sorted(amsler_test_list, key=lambda x: x.created_at)
    latest = sorted_list[-1]

    age_group = {
        9: "9ì„¸ ì´í•˜", 1: "10ëŒ€", 2: "20ëŒ€", 4: "30ëŒ€",
        5: "40ëŒ€", 6: "50ëŒ€", 7: "60ëŒ€", 8: "70ì„¸ ì´ìƒ"
    }.get(survey.age, f"ì½”ë“œ {survey.age}")

    gender_text = "ë‚¨ì„±" if survey.gender == "M" else "ì—¬ì„±"

    surgery_desc = {
        "normal": "ìˆ˜ìˆ  ì´ë ¥ ì—†ìŒ",
        "correction": "ë¼ì‹/ë¼ì„¹ ìˆ˜ìˆ  ì´ë ¥",
        "cataract": "ë°±ë‚´ì¥ ìˆ˜ìˆ  ì´ë ¥",
        "etc": "ê¸°íƒ€ ìˆ˜ìˆ  ì´ë ¥"
    }.get(survey.surgery, survey.surgery)

    abnormal_map = {
        "n": "ì •ìƒ",
        "d": "ì™œê³¡ëœ ì‹œì•¼(í™©ë°˜ë³€ì„± ì˜ì‹¬)",
        "b": "ê²€ê²Œ ë³´ì´ëŠ” ì˜ì—­(ì¤‘ì‹¬ ë§¹ì  ê°€ëŠ¥)",
        "w": "íë¦¬ê±°ë‚˜ í•˜ì–—ê²Œ ë³´ì„(ì‹œì‹ ê²½ ì´ìƒ ë˜ëŠ” ë°±ë‚´ì¥ ì˜ì‹¬)"
    }

    def interpret(loc_string):
        codes = re.split(r"[,\s]+", loc_string.strip().lower())
        return [abnormal_map[c] for c in codes if c in abnormal_map and c != "n"]

    left_issues = interpret(latest.left_macular_loc)
    right_issues = interpret(latest.right_macular_loc)

    def summary_text(eye: str, issues: list[str]):
        if not issues:
            return f"{eye} ëˆˆì€ íŠ¹ì´ ì†Œê²¬ì´ ì—†ìŠµë‹ˆë‹¤."
        else:
            joined = ", ".join(issues)
            return f"{eye} ëˆˆì—ì„œ {joined}ì´(ê°€) ê´€ì°°ë©ë‹ˆë‹¤."

    left_summary = summary_text("ì™¼ìª½", left_issues)
    right_summary = summary_text("ì˜¤ë¥¸ìª½", right_issues)

    return f"""
ë‹¹ì‹ ì€ í™©ë°˜ ì§ˆí™˜ì„ ì§„ë‹¨í•˜ëŠ” ì•ˆê³¼ ì „ë¬¸ì˜ì…ë‹ˆë‹¤.
ì•„ë˜ ê²€ì‚¬ ì •ë³´ë¥¼ ì°¸ê³ í•˜ì—¬, ê°€ì¥ ìµœê·¼ ì•”ìŠ¬ëŸ¬ ì°¨íŠ¸ ê²€ì‚¬ ê²°ê³¼ë¥¼ ì‚¬ìš©ìê°€ ì´í•´í•˜ê¸° ì‰¬ìš´ ì–¸ì–´ë¡œ ì„¤ëª…í•´ ì£¼ì„¸ìš”.

<ì¶œë ¥ ê·œì¹™>
- JSON ì—†ì´ ìˆœìˆ˜ comment ë¬¸ì¥ í•œ ì¤„ë§Œ ì¶œë ¥í•˜ì„¸ìš”.
- ìµœëŒ€ 2ë¬¸ì¥, ë¬¸ì¥ë‹¹ ì•½ 50ì ì´ë‚´ë¡œ ë¶€ë“œëŸ½ê³  ëª…í™•í•˜ê²Œ ì‘ì„±í•©ë‹ˆë‹¤.
- ì˜í•™ ìš©ì–´ëŠ” ê°€ëŠ¥í•œ í•œ í”¼í•˜ê³ , ê°ê°ì ì´ê³  ì‰¬ìš´ í‘œí˜„ìœ¼ë¡œ ëŒ€ì²´í•˜ì„¸ìš”.
  ì˜ˆ: "ì¤‘ì‹¬ ì‹œì•¼ê°€ ê°€ë ¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤", "ì¼ê·¸ëŸ¬ì§ì´ ë³´ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤"

<ì£¼ì˜ ì‚¬í•­>
- í™©ë°˜ë³€ì„±, ì¤‘ì‹¬ ë§¹ì  ë“±ì˜ ë³‘ëª…ì€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
- ì‚¬ìš©ìì˜ ë‹¹ë‡¨, í¡ì—°, ìˆ˜ìˆ  ì´ë ¥ì€ íŒë‹¨ì— ê°„ì ‘ ì°¸ê³ ë§Œ í•˜ê³ , commentì—ëŠ” ì§ì ‘ ë“œëŸ¬ë‚´ì§€ ë§ˆì„¸ìš”.
- í˜„ì¬ ìƒíƒœì™€ í•„ìš”í•œ ì¡°ì¹˜ë¥¼ ê°„ë‹¨íˆ ì•ˆë‚´í•´ì£¼ì„¸ìš”.
- ì¦ìƒì´ ì—†ì„ ê²½ìš°ì—ë„ ì •ê¸° ê²€ì‚¬ ê¶Œìœ  ë¬¸êµ¬ë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”.

ğŸ“Œ ì˜ˆì‹œ:
- "ì™¼ìª½ ëˆˆ ì¤‘ì‹¬ì—ì„œ ì¼ê·¸ëŸ¬ì§ì´ ë³´ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì •ë°€ ê²€ì‚¬ë¥¼ í†µí•´ ìƒíƒœ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."
- "ì–‘ìª½ ëˆˆ ëª¨ë‘ íŠ¹ì´ ì†Œê²¬ì´ ì—†ìŠµë‹ˆë‹¤. ì£¼ê¸°ì ì¸ ê²€ì‚¬ë¥¼ ê¶Œì¥ë“œë¦½ë‹ˆë‹¤."

[ë¬¸ì§„ ì •ë³´ ìš”ì•½]
- ë‚˜ì´ëŒ€: {age_group}
- ì„±ë³„: {gender_text}
- ì•ˆê²½ ì°©ìš©: {"ì°©ìš©" if survey.glasses else "ë¹„ì°©ìš©"}
- ìˆ˜ìˆ  ì´ë ¥: {surgery_desc}
- ë‹¹ë‡¨ ì—¬ë¶€: {"ìˆìŒ" if survey.diabetes else "ì—†ìŒ"}
- í¡ì—° ì—¬ë¶€: {"ìˆìŒ" if survey.smoking else "ì—†ìŒ"}

[ìµœê·¼ ì•”ìŠ¬ëŸ¬ ì°¨íŠ¸ ê²€ì‚¬ ìš”ì•½]
- ê²€ì‚¬ì¼ì: {latest.created_at.strftime('%Y-%m-%d')}
- {left_summary}
- {right_summary}

â›” ë°˜ë“œì‹œ ìœ„ ì •ë³´ë¥¼ ì°¸ê³ í•´ ë¶€ë“œëŸ¬ìš´ comment ë¬¸ì¥ë§Œ ì¶œë ¥í•˜ì„¸ìš”.
"""
